var map=L.map("map",{doubleClickZoom:false}).setView([52.2385,-123.1185],6);L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{}).addTo(map);L.control.locate().addTo(map);function getOpacity(c){return c=="Definitely"?"0.8":c=="Likely"?"0.5":"0.1"}function style(feature){return{weight:2,dashArray:"",opacity:.2,color:"black",fillOpacity:"0.8",fillColor:feature.properties.party?feature.properties.party.colour:"rgba(255,255,255,.1)"}}var geojson;geojson=L.geoJson(ridingData,{style:style,onEachFeature:onEachFeature}).addTo(map);var VanSouthWest=new L.LatLng(48.927,-123.186),VanNorthEast=new L.LatLng(49.398,-122.353),vancouver=new L.LatLngBounds(VanSouthWest,VanNorthEast);var VicSouthWest=new L.LatLng(48.268,-124.845),VicNorthEast=new L.LatLng(49.183,-123.179),victoria=new L.LatLngBounds(VicSouthWest,VicNorthEast);function zoomToRegion(LatLng){map.fitBounds(LatLng)}var info=L.control();info.onAdd=function(map){this._div=L.DomUtil.create("div","info");this.update();return this._div};info.update=function(properties){this._div.innerHTML=properties?"<h4>"+properties.name+"</h4><p><strong>Winner:</strong> "+properties.winner.fullname+(properties.party?' <span class="label label-'+properties.party.slug+'" style="background-color: '+properties.party.colour+';">'+properties.party.shortname+"<span>":"")+"<p>"+properties.win_copy+" Click to read more.</p>":"<p><h4>Welcome to Tyee’s riding-by-riding source for election issues and action.</h4></p>"+"<p>Now updated to reflect the winners of the 2013 B.C. election. Click a riding for fast facts, related stories and more.</p>"+'<p><a href="#riding-list">Scroll down</a> for a list of ridings</p>'+'<p>Zoom to <a href="#" onClick="event.preventDefault();zoomToRegion(vancouver);">Lower Mainland ridings</a>.</p>'+'<p>Zoom to <a href="#" onClick="event.preventDefault();zoomToRegion(victoria);">Victoria-area ridings</a>.</p>'};info.addTo(map);var search=L.control({});search.onAdd=function(map){var div=L.DomUtil.create("div","search");this._div=div;this.update();L.DomEvent.disableClickPropagation(this._div);return this._div};search.update=function(){this._div.innerHTML="<p><strong>Not sure what your riding is?</strong><br />"+"Type your address in the box below and we’ll get you there."+'<form id="riding-search" class="riding-search">'+'<input type="text" size="25" placeholder="Your address: Street, City." autofocus />&nbsp;'+'<input type="submit" value="Go" />'+"</form>"+'<div id="riding-message" class="riding-message"></div>'};search.addTo(map);function highlightFeature(e){var layer=e.target;layer.setStyle({weight:5});if(!L.Browser.ie&&!L.Browser.opera){layer.bringToFront()}info.update(layer.feature.properties)}function resetHighlight(e){geojson.resetStyle(e.target);info.update()}function goToRidingProfile(e){var layer=e.target;var slug=layer.feature.properties.name;slug=slug.toLowerCase().replace(/\s/g,"-");url="/riding/"+slug;window.location=url}function onEachFeature(feature,layer){layer.on({mouseover:highlightFeature,mouseout:resetHighlight,click:goToRidingProfile})}var message_div=$(".riding-message");$(".riding-search").submit(function(e){e.preventDefault();var geocoder=new google.maps.Geocoder;var search=$("#riding-search input[type=text]").val();var mobile=$("#riding-search-mobile input[type=text]").val();var address=search?search:mobile;geocoder.geocode({address:address,region:"ca"},function(results,status){show_options(results)})});function show_options(results){message_div.children().remove();if(results.length>1){message_div.append("<p>Which of these looks like your address?</p>").removeClass("alert-error alert-success").addClass("alert alert-warning");$.each(results,function(){var result=this;message_div.append($('<a href="#" onClick="event.preventDefault();">'+this.formatted_address+"</a><br />").click(function(){districts_for_geocoder_result(result)}))})}else if(results.length==0){message_div.append("<p>No match for that address.</p>").removeClass("alert-warning").addClass("alert alert-error")}else{districts_for_geocoder_result(results[0])}}if(navigator.geolocation){var geocoder=new google.maps.Geocoder;$("#geolocate-span").show();$("#geolocate-link").click(function(e){e.preventDefault();navigator.geolocation.getCurrentPosition(function(position){var geolocateLatLng=new google.maps.LatLng(position.coords.latitude,position.coords.longitude);geocoder.geocode({latLng:geolocateLatLng},function(results,status){show_options(results)})})})}function districts_for_geocoder_result(result){message_div.children().remove();message_div.append("<p>"+result.formatted_address+"</p>");var lat=result.geometry.location.lat();var lng=result.geometry.location.lng();var url="http://represent.opennorth.ca/boundaries/?callback=?&contains="+lat+","+lng;$.getJSON(url,function(data){data=data.objects;if(data.length==0){message_div.append("<p>No ridings found. Is that address in Canada?</p>").removeClass("alert-success").addClass("alert-error")}$.each(data,function(index){if(this.boundary_set_name=="British Columbia electoral district"){var link=this.name.toLowerCase().replace(/\s/g,"-");message_div.append('<p>Your riding is <a href="/riding/'+link+'">'+this.name+", visit the riding profile</a>.</p>").removeClass("alert-warning").addClass("alert alert-success");map.setView([lat,lng],14)}})})}